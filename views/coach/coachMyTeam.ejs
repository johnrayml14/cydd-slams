<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Organizations</title>
    <link rel="stylesheet" href="/styles/frontpage.css">
    <link rel="stylesheet" href="/styles/coachMyTeam.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

</head>
<body>
    <!-- Sidebar Menu -->
    <div id="mySidebar" class="sidebar">
        <a href="/coach/homepage"><i class="fas fa-home"></i> Home</a>
        <a href="/coach/posts"><i class="fas fa-newspaper"></i> Posts</a>
        <a href="/coach/gallery"><i class="fas fa-image"></i> Gallery</a>
        <a href="/coach/events"><i class="fas fa-calendar-alt"></i> Events</a>
        <!-- Team link with sub-sidebar -->
        <a href="javascript:void(0);" class="team-link" onclick="toggleSubSidebar()"><i class="fas fa-users-cog"></i> Team</a>
        <div class="sub-sidebar" id="subSidebar">
            <a href="/coach/my-team" class="active"><i class="fas fa-users"></i> My Team</a>
            <a href="/coach/all-teams"><i class="fas fa-landmark"></i> All Teams</a>
        </div>
    </div>

    <!-- Sidebar toggle button -->
    <span class="sidebar-btn" onclick="toggleNav()">&#9776;</span>

    <header class="header">
        <div class="logo">
            <a href="/coach/homepage" style="text-decoration: none;">
                <img src="/images/cityYouth.jpg" alt="SLAMS Logo">
            </a>
            <span class="slams-title">SLAMS</span>
        </div>

        <div class="menu-bar">
            <div class="user-profile">
                <% if (coach && coach.coachProfile) { %>
                    <img src="<%= coach.coachProfile %>" alt="Profile" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #fff;">
                <% } else { %>
                    <i class="fas fa-user-shield"></i>
                <% } %>
                
            </div>
        </div>
    </header>
    <div class="dropdown-content">
                    <a href="/coach/profile">
                        <i class="fas fa-cogs" style="margin-right: 8px;"></i> Profile
                    </a>
                    <a href="javascript:void(0);" class="logout-btn" onclick="showLogoutModal()">
                        <i class="fas fa-sign-out-alt" style="margin-right: 8px;"></i> Log Out
                    </a>
                </div>
    <main class="dashboard-container">
        <div class="page-header">
            <h1><i class="fas fa-landmark"></i> My Team</h1>
        </div>

        <% if (teams.length > 0) { %>
            <div class="team-container">
                <% teams.forEach(team => { %>
                    <div class="team-card <%= team.team_status %>">
                        <div class="team-header">
                            <% if (team.teamProfile) { %>
                                <img src="<%= team.teamProfile %>" alt="<%= team.teamName %>" class="team-profile">
                            <% } else { %>
                                <div class="team-profile" style="background: #eee; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-users" style="font-size: 30px; color: #aaa;"></i>
                                </div>
                            <% } %>
                            <div class="team-info">
                                <h2 class="team-name"><%= team.teamName %></h2>
                                <p class="team-meta">
                                    <i class="fas fa-building"></i> <%= team.organization %>
                                </p>
                                <span class="status-badge <%= 'status-' + team.team_status %>">
                                    <i class="fas fa-<%= team.team_status === 'confirmed' ? 'check-circle' : (team.team_status === 'pending' ? 'clock' : 'times-circle') %>"></i>
                                    <%= team.team_status.charAt(0).toUpperCase() + team.team_status.slice(1) %>
                                </span>
                            </div>
                        </div>

                        <% if (team.event_sports) { %>
                            <!-- Replace the existing sports-tags section with this updated version -->
                            <div class="sports-tags" aria-label="Sports offered by this organization">
                                <span><i class="fas fa-running" aria-hidden="true"></i> Activities:</span>
                                <% 
                                // Combine sports, esports and other_activities from the event
                                const allActivities = [];
                                
                                // Process regular sports
                                if (team.event_sports) {
                                    allActivities.push(...team.event_sports.split(',').map(s => s.trim()));
                                }
                                
                                // Process esports (convert codes to display names)
                                if (team.event_esports) {
                                    const esportsMap = {
                                        'ml': 'Mobile Legends',
                                        'codm': 'CODM'
                                    };
                                    allActivities.push(...team.event_esports.split(',').map(code => esportsMap[code.trim()] || code.trim()));
                                }
                                
                                // Process other activities (convert codes to display names)
                                if (team.event_other_activities) {
                                    const activitiesMap = {
                                        'cheerdance': 'Cheerdance',
                                        'dance_competition': 'Dance Competition', 
                                        'singing_contest': 'Singing Contest'
                                    };
                                    allActivities.push(...team.event_other_activities.split(',').map(code => activitiesMap[code.trim()] || code.trim()));
                                }
                                
                                // Display each activity
                                allActivities.forEach(activity => { 
                                    const count = playerCounts[team.team_id] && playerCounts[team.team_id][activity] || 0;
                                %>
                                    <a href="/coach/sport-players?sport=<%= encodeURIComponent(activity) %>&teamId=<%= team.team_id %>" 
                                    class="sport-tag"
                                    title="View <%= activity %> players">
                                        <%= activity %>
                                        <span class="player-count" aria-label="<%= count %> players">
                                            (<%= count %>)
                                        </span>
                                    </a>
                                <% }); %>
                            </div>
                        <% } %>

                        <% if (team.event_id) { %>
                            <div class="event-section">
                                <h3 class="section-title"><i class="fas fa-calendar-check"></i> Event Details</h3>
                                <% if (team.event_image) { %>
                                    <div class="event-image-container">
                                        <img src="<%= team.event_image %>" alt="<%= team.event_title %>" class="event-image">
                                    </div>
                                <% } %>
                                <h4 class="event-title"><%= team.event_title %></h4>
                                <p class="event-description"><%= team.event_description %></p>
                                <div class="event-meta">
                                    <span><i class="far fa-calendar-alt"></i> <%= formatDate(team.date_schedule) %></span>
                                    <span><i class="fas fa-map-marker-alt"></i> <%= team.location %></span>
                                </div>
                                <div class="event-meta">
                                    <span>Status: 
                                        <span class="status-badge <%= team.event_status === 'ongoing' ? 'status-confirmed' : 'status-rejected' %>">
                                            <%= team.event_status %>
                                        </span>
                                    </span>
                                </div>
                            </div>
                        <% } else if (team.team_status === 'rejected') { %>
                            <div class="event-section">
                                <div class="status-badge status-rejected">
                                    <i class="fas fa-exclamation-circle"></i> 
                                    Sorry, your organization was not approved for this event.
                                </div>
                            </div>
                        <% } %>
                        <% if (playerRequests[team.team_id] && playerRequests[team.team_id].length > 0) { %>
                        <div class="player-requests-section">
                            <div class="requests-header">
                                <h3 class="requests-title">
                                    <i class="fas fa-user-plus"></i> Player Requests
                                    <span class="requests-count">
                                        <%= playerRequests[team.team_id].filter(p => p.status === 'pending').length %>
                                    </span>
                                </h3>
                            </div>
                            
                            <table class="requests-table">
                                <thead>
                                    <tr>
                                        <th>Player</th>
                                        <th>Details</th>
                                        <th>Sports</th>  <!-- Added Sports column -->
                                        <th>Documents</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% playerRequests[team.team_id].forEach(player => { %>
                                        <tr>
                                            <td>
                                                <div class="player-profile">
                                                    <% if (player.user_profile) { %>
                                                        <img src="<%= player.user_profile %>" alt="<%= player.player_name %>" class="player-avatar">
                                                    <% } else { %>
                                                        <div class="player-avatar" style="background: #eee; display: flex; align-items: center; justify-content: center;">
                                                            <i class="fas fa-user" style="color: #aaa;"></i>
                                                        </div>
                                                    <% } %>
                                                    <div>
                                                        <div class="player-name"><%= player.player_name %></div>
                                                        <div class="player-meta">
                                                            <%= player.age %> years • <%= player.sex %>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div><%= player.school %></div>
                                                <div class="player-meta"><%= player.year_level %></div>
                                                <div class="player-meta"><%= player.contact_number %></div>
                                            </td>
                                            <td>
                                                <div class="sports-info">
                                                    <% if (player.sports) { %>
                                                        <i class="fas fa-basketball-ball"></i> <%= player.sports %>
                                                    <% } else { %>
                                                        <span class="no-sports">Not specified</span>
                                                    <% } %>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="documents-list">
                                                    <% if (player.PSA) { %>
                                                        <a href="/<%= player.PSA %>" target="_blank" class="document-link">
                                                            <i class="fas fa-file-pdf"></i> PSA
                                                        </a>
                                                    <% } %>
                                                    <% if (player.waiver) { %>
                                                        <a href="/<%= player.waiver %>" target="_blank" class="document-link">
                                                            <i class="fas fa-file-pdf"></i> Waiver
                                                        </a>
                                                    <% } %>
                                                    <% if (player.med_cert) { %>
                                                        <a href="/<%= player.med_cert %>" target="_blank" class="document-link">
                                                            <i class="fas fa-file-pdf"></i> Med Cert
                                                        </a>
                                                    <% } %>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="status-badge status-<%= player.status %>">
                                                    <i class="fas fa-<%= player.status === 'confirmed' ? 'check-circle' : (player.status === 'pending' ? 'clock' : 'times-circle') %>"></i>
                                                    <%= player.status %>
                                                </span>
                                            </td>
                                            <td>
                                            <% if (player.status === 'pending') { %>
                                                <div class="action-buttons">
                                                <form action="/coach/team/approve-player" method="POST" style="display:inline;">
                                                    <input type="hidden" name="teamId" value="<%= team.team_id %>">
                                                    <input type="hidden" name="playerId" value="<%= player.id %>">
                                                    <input type="hidden" name="action" value="confirm">
                                                    <button type="submit" class="action-btn approve-btn">
                                                    <i class="fas fa-check"></i> Approve
                                                    </button>
                                                </form>
                                                
                                                <form action="/coach/team/approve-player" method="POST" style="display:inline;">
                                                    <input type="hidden" name="teamId" value="<%= team.team_id %>">
                                                    <input type="hidden" name="playerId" value="<%= player.id %>">
                                                    <input type="hidden" name="action" value="reject">
                                                    <button type="submit" class="action-btn reject-btn">
                                                    <i class="fas fa-times"></i> Reject
                                                    </button>
                                                </form>
                                                </div>
                                            <% } else { %>
                                                <span class="action-message <%= player.status === 'confirmed' ? 'confirmed' : 'rejected' %>">
                                                <%= player.status === 'confirmed' ? 'Approved' : 'Rejected' %>
                                                </span>
                                            <% } %>
                                            </td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>
                    <% } %>
                    </div>
                <% }); %>
            </div>
        <% } else { %>
            <div class="no-teams">
                <i class="fas fa-users"></i>
                <h3>No Organizations Found</h3>
                <p>You haven't registered any organizations yet.</p>
                <a href="/coach/events" class="register-btn">
                    <i class="fas fa-plus"></i> Register for an Event
                </a>
            </div>
        <% } %>
    </main>

    <!-- Modal for logout confirmation -->
    <div id="logoutModal" class="modal">
        <div class="modal-content">
            <h3>Are you sure you want to log out?</h3>
            <button id="confirmLogout" class="confirm-btn">Confirm</button>
            <button id="cancelLogout" class="cancel-btn">Cancel</button>
        </div>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", function () {
        let isSidebarOpen = false;

        const sidebar = document.getElementById("mySidebar");
        const sidebarBtn = document.querySelector(".sidebar-btn");
        const content = document.querySelector(".dashboard-container");

        // Sidebar toggle
        window.toggleNav = function () {
            if (isSidebarOpen) {
                sidebar.style.left = "-240px";
                if (content) content.style.marginLeft = "0";
                sidebarBtn.innerHTML = "&#9776;";
            } else {
                sidebar.style.left = "0";
                if (content) content.style.marginLeft = "240px";
                sidebarBtn.innerHTML = "&times;";
            }
            isSidebarOpen = !isSidebarOpen;
        };

        // Sub-sidebar toggle
        const subSidebar = document.getElementById("subSidebar");
        const teamLink = document.querySelector(".team-link");

        window.toggleSubSidebar = function () {
            if (subSidebar.style.display === "block") {
                subSidebar.style.display = "none";
                teamLink.classList.remove("active");
            } else {
                subSidebar.style.display = "block";
                teamLink.classList.add("active");
            }
        };

        // Logout Modal logic
        const logoutModal = document.getElementById('logoutModal');
        const confirmLogout = document.getElementById('confirmLogout');
        const cancelLogout = document.getElementById('cancelLogout');

        window.showLogoutModal = function () {
            logoutModal.style.display = 'block';
        };

        function hideLogoutModal() {
            logoutModal.style.display = 'none';
        }

        if (confirmLogout) {
            confirmLogout.addEventListener('click', function () {
                window.location.href = '/coach/logout';
            });
        }

        if (cancelLogout) {
            cancelLogout.addEventListener('click', function () {
                hideLogoutModal();
            });
        }

        // User profile dropdown
        const userProfile = document.querySelector('.user-profile');
        const dropdown = document.querySelector('.dropdown-content');
        let hideTimeout;

        userProfile.addEventListener('click', function(e) {
            e.stopPropagation();
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        });

        if (userProfile && dropdown) {
            userProfile.addEventListener('mouseenter', () => {
                clearTimeout(hideTimeout);
                dropdown.classList.add('show');
            });

            userProfile.addEventListener('mouseleave', () => {
                hideTimeout = setTimeout(() => {
                    dropdown.classList.remove('show');
                }, 1500);
            });
        }
    });



    // View player details (you can implement a modal or separate page)
    function viewPlayerDetails(playerId) {
        window.location.href = `/coach/player/${playerId}`;
    }
    </script>
</body>

</html>

